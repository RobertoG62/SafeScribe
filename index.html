<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeScribe V2 - תמלול חכם</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap');
        body { font-family: 'Rubik', sans-serif; }
        .recording-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col">

    <header class="bg-slate-800 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-wave-square text-teal-400 text-2xl"></i>
                <h1 class="text-lg font-bold">SafeScribe <span class="text-xs bg-teal-600 px-1 rounded">V2.0</span></h1>
            </div>
            <button onclick="newMeeting()" class="text-xs bg-red-500 hover:bg-red-600 px-3 py-1.5 rounded shadow transition">
                <i class="fas fa-eraser"></i> ישיבה חדשה
            </button>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-4 max-w-3xl">
        
        <div class="bg-white rounded-xl shadow-sm p-6 mb-4">
            <div class="text-center mb-6">
                <p id="status" class="text-sm text-gray-500 mb-2">מוכן להקלטה</p>
                <div class="flex justify-center gap-4">
                    <button id="startBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-full w-20 h-20 flex items-center justify-center text-3xl transition-all shadow-lg transform hover:scale-105">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="stopBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-full w-20 h-20 flex items-center justify-center text-3xl transition-all hidden">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="exportTxt()" class="bg-teal-600 hover:bg-teal-700 text-white p-3 rounded-lg text-sm flex items-center justify-center gap-2 shadow-sm">
                    <i class="fas fa-file-alt"></i>
                    <span>הורד כטקסט נקי</span>
                    <span class="text-xs opacity-70">(לסיכום)</span>
                </button>
                
                <button onclick="exportJson()" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg text-sm flex items-center justify-center gap-2 shadow-sm">
                    <i class="fas fa-code"></i>
                    <span>שמור גיבוי מלא</span>
                    <span class="text-xs opacity-70">(להמשך עריכה)</span>
                </button>
            </div>
             <div class="mt-3 text-center">
                <label for="fileInput" class="text-xs text-blue-600 cursor-pointer hover:underline">
                    <i class="fas fa-upload"></i> טען גיבוי קודם
                </label>
                <input type="file" id="fileInput" accept=".json" class="hidden" onchange="importData(this)">
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm min-h-[300px] p-4 relative">
            <div class="absolute top-0 right-0 bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-bl-lg">
                <i class="fas fa-history"></i> היסטוריה
            </div>
            <div id="transcriptContainer" class="space-y-3 mt-4 pb-10">
                <div id="emptyState" class="text-center text-gray-300 py-10">
                    <i class="fas fa-comment-dots text-4xl mb-3"></i>
                    <p>התמלול יופיע כאן בזמן אמת...</p>
                </div>
            </div>
        </div>

    </main>

    <footer class="text-center p-4 text-xs text-gray-400">
        SafeScribe Local • נבנה ע"י רוברטו
    </footer>

    <script>
        // משתנים גלובליים
        let recognition;
        let isRecording = false;
        let transcriptData = []; 
        let wakeLock = null; // למניעת כיבוי מסך

        // אתחול זיהוי דיבור
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'he-IL';

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        addTranscriptEntry(event.results[i][0].transcript);
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                // עדכון סטטוס עם טקסט זמני אם רוצים (כרגע פשוט נחכה לסופי)
            };

            recognition.onerror = (event) => {
                console.error("Speech error:", event.error);
                document.getElementById('status').innerText = "שגיאה: " + event.error;
                if(event.error === 'not-allowed') alert("חובה לאשר מיקרופון!");
            };

            recognition.onend = () => {
                if (isRecording) {
                    console.log("Restarting recognition...");
                    recognition.start();
                } else {
                    toggleUI(false);
                    releaseWakeLock();
                }
            };
        } else {
            alert("הדפדפן לא תומך. נא להשתמש בכרום.");
        }

        // ניהול הקלטה
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');

        startBtn.onclick = async () => {
            if (!recognition) return;
            try {
                transcriptData = []; // אופציונלי: אם רוצים איפוס אוטומטי בהתחלה. כרגע נשאיר את זה ל"ישיבה חדשה"
                recognition.start();
                isRecording = true;
                toggleUI(true);
                requestWakeLock(); // הפעלת מניעת כיבוי מסך
            } catch (e) { console.error(e); }
        };

        stopBtn.onclick = () => {
            isRecording = false;
            recognition.stop();
            toggleUI(false);
            releaseWakeLock();
        };

        function toggleUI(recording) {
            const status = document.getElementById('status');
            if (recording) {
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                stopBtn.classList.add('recording-pulse');
                status.innerText = "מקליט... (המסך ישאר דולק)";
                status.className = "text-red-500 font-bold animate-pulse mb-2";
            } else {
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                stopBtn.classList.remove('recording-pulse');
                status.innerText = "ההקלטה נעצרה";
                status.className = "text-gray-500 mb-2";
            }
        }

        // ניהול Wake Lock (מניעת כיבוי מסך)
        async function requestWakeLock() {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Screen Wake Lock active');
            } catch (err) {
                console.error(`${err.name}, ${err.message}`);
            }
        }

        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release().then(() => { wakeLock = null; });
            }
        }

        // הוספת טקסט למסך ולזיכרון
        function addTranscriptEntry(text) {
            if (!text.trim()) return;
            const now = new Date();
            const timeStr = now.toLocaleTimeString('he-IL', {hour: '2-digit', minute:'2-digit', second: '2-digit'});
            
            transcriptData.push({ time: timeStr, text: text });
            render();
            saveToLocal();
        }

        function render() {
            const container = document.getElementById('transcriptContainer');
            if (transcriptData.length === 0) {
                container.innerHTML = `<div id="emptyState" class="text-center text-gray-300 py-10"><i class="fas fa-comment-dots text-4xl mb-3"></i><p>התמלול יופיע כאן...</p></div>`;
                return;
            }
            
            container.innerHTML = transcriptData.map(item => `
                <div class="bg-gray-50 p-3 rounded border-r-4 border-teal-500 text-right">
                    <span class="text-xs text-gray-400 block mb-1">${item.time}</span>
                    <p class="text-gray-800">${item.text}</p>
                </div>
            `).join('');
            
            window.scrollTo(0, document.body.scrollHeight);
        }

        // --- כפתורי ייצוא וניהול ---

        // 1. ייצוא לטקסט נקי (לסיכום)
        function exportTxt() {
            if (transcriptData.length === 0) { alert("אין תוכן לייצא"); return; }
            
            let textContent = "SafeScribe Transcript\n=====================\n\n";
            transcriptData.forEach(item => {
                textContent += `[${item.time}] ${item.text}\n`;
            });

            downloadFile(textContent, 'txt', 'text/plain');
        }

        // 2. ייצוא ל-JSON (לגיבוי)
        function exportJson() {
            if (transcriptData.length === 0) { alert("אין תוכן לשמור"); return; }
            const jsonContent = JSON.stringify(transcriptData, null, 2);
            downloadFile(jsonContent, 'json', 'application/json');
        }

        // פונקציית עזר להורדה עם שם חכם
        function downloadFile(content, extension, mimeType) {
            const now = new Date();
            // יצירת שם ייחודי עם תאריך ושעה: meeting_2023-10-25_14-30-05
            const dateStr = now.toISOString().slice(0,10);
            const timeStr = now.toTimeString().slice(0,8).replace(/:/g, '-');
            const filename = `meeting_${dateStr}_${timeStr}.${extension}`;

            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 3. ישיבה חדשה
        function newMeeting() {
            if(transcriptData.length > 0 && !confirm("האם למחוק את התמלול הנוכחי ולהתחיל דף חדש? (וודא ששמרת לפני)")) return;
            
            transcriptData = [];
            saveToLocal();
            render();
            document.getElementById('status').innerText = "התחלה חדשה ונקייה";
        }

        // שמירה וטעינה אוטומטית
        function saveToLocal() { localStorage.setItem('safeScribeData', JSON.stringify(transcriptData)); }
        
        function loadFromLocal() {
            const data = localStorage.getItem('safeScribeData');
            if (data) { transcriptData = JSON.parse(data); render(); }
        }

        // טעינת קובץ גיבוי ישן
        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    transcriptData = JSON.parse(e.target.result);
                    saveToLocal();
                    render();
                    alert("הגיבוי נטען בהצלחה!");
                } catch(err) { alert("שגיאה בקריאת הקובץ"); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        loadFromLocal(); // הפעלה ראשונית
    </script>
</body>
</html>
