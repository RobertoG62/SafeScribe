<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SafeScribe V5 Hybrid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap');
        body { font-family: 'Rubik', sans-serif; }
        
        .pulse-ring { animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(220, 38, 38, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        
        /* Language Toggle Animation */
        .lang-btn.active { background-color: #e0e7ff; border-color: #6366f1; color: #4338ca; transform: scale(1.05); }
    </style>
</head>
<body class="bg-slate-50 text-gray-800 h-screen flex flex-col overflow-hidden">

    <header class="bg-slate-900 text-white p-3 shadow-lg flex-shrink-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-globe-americas text-teal-400 text-xl"></i>
                <h1 class="text-lg font-bold tracking-wide">SafeScribe <span class="text-[10px] bg-purple-600 px-1.5 py-0.5 rounded ml-1 align-middle">V5 HYBRID</span></h1>
            </div>
            <button onclick="newMeeting()" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded border border-slate-600 transition flex items-center gap-2">
                <i class="fas fa-file-circle-plus"></i> 砖
            </button>
        </div>
    </header>

    <main class="flex-grow flex flex-col container mx-auto p-2 sm:p-4 max-w-4xl min-h-0 gap-3">
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 flex-shrink-0 z-40">
            
            <div class="flex flex-col items-center mb-2">
                <div id="statusBadge" class="px-4 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-500 mb-4 transition-all duration-300">
                     拽
                </div>

                <div class="relative mb-4">
                    <button id="mainBtn" onclick="toggleRecording()" class="relative z-10 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full w-20 h-20 flex items-center justify-center text-3xl shadow-xl transition-all duration-300 transform hover:scale-105 active:scale-95">
                        <i class="fas fa-microphone" id="btnIcon"></i>
                    </button>
                    <div id="pulseRing" class="absolute inset-0 rounded-full bg-red-500 opacity-0 transition-opacity duration-300"></div>
                </div>

                <div class="flex bg-gray-100 p-1 rounded-lg gap-1 mb-2">
                    <button onclick="changeLang('he-IL')" id="btnHe" class="lang-btn active px-4 py-1.5 rounded-md text-sm font-medium text-gray-600 border border-transparent transition-all flex items-center gap-2">
                        <span></span> 注专转
                    </button>
                    <button onclick="changeLang('en-US')" id="btnEn" class="lang-btn px-4 py-1.5 rounded-md text-sm font-medium text-gray-600 border border-transparent transition-all flex items-center gap-2">
                        <span>吼</span> English
                    </button>
                </div>
                <p class="text-[10px] text-gray-400">抓 驻转 砖驻  转</p>
            </div>

            <div class="bg-indigo-50 rounded-lg p-3 border border-indigo-100 min-h-[50px] flex flex-col justify-center">
                <span class="text-[10px] text-indigo-400 font-bold uppercase tracking-wider mb-1 flex justify-between">
                    <span><i class="fas fa-bolt"></i>  </span>
                    <span id="currentLangDisplay" class="text-indigo-300">HE</span>
                </span>
                <p id="interimText" class="text-indigo-900 font-medium text-lg leading-tight min-h-[1.5rem]">...</p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex-grow flex flex-col relative overflow-hidden">
            <div class="bg-gray-50 px-4 py-2 border-b flex justify-between items-center">
                <span class="text-xs font-bold text-gray-500"><i class="fas fa-check-double text-green-500"></i> 住专</span>
                <div class="flex gap-2">
                    <button onclick="exportTxt()" class="text-xs bg-white border border-gray-300 hover:bg-gray-50 px-2 py-1 rounded text-gray-700">
                        <i class="fas fa-download"></i> TXT
                    </button>
                </div>
            </div>
            
            <div id="transcriptContainer" class="flex-grow overflow-y-auto p-4 space-y-4 custom-scrollbar scroll-smooth bg-white">
                <div id="emptyState" class="flex flex-col items-center justify-center h-full text-gray-300 opacity-60">
                    <i class="fas fa-language text-5xl mb-4"></i>
                    <p class="text-sm">转 拽 注专转  转</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        let recognition;
        let isRecording = false;
        let transcriptData = [];
        let wakeLock = null;
        let currentLang = 'he-IL'; // 砖驻转 专专转 

        const mainBtn = document.getElementById('mainBtn');
        const btnIcon = document.getElementById('btnIcon');
        const statusBadge = document.getElementById('statusBadge');
        const pulseRing = document.getElementById('pulseRing');
        const interimDisplay = document.getElementById('interimText');
        const container = document.getElementById('transcriptContainer');
        const langDisplay = document.getElementById('currentLangDisplay');

        // 转 注专转
        function initRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = currentLang;

                recognition.onstart = () => {
                    isRecording = true;
                    updateStatus('recording');
                    requestWakeLock();
                };

                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            addTranscriptEntry(event.results[i][0].transcript);
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    if(interimTranscript) {
                        interimDisplay.innerText = interimTranscript;
                        interimDisplay.style.opacity = "1";
                        //  拽住 驻 砖驻
                        interimDisplay.style.direction = currentLang === 'he-IL' ? 'rtl' : 'ltr';
                    }
                };

                recognition.onend = () => {
                    if (isRecording) {
                        // 驻注 砖 转 ( 专 驻转 砖驻)
                        recognition.start(); 
                    } else {
                        updateStatus('idle');
                        releaseWakeLock();
                    }
                };
                
                recognition.onerror = (event) => {
                    console.error("Error:", event.error);
                    if (event.error === 'not-allowed') {
                        isRecording = false;
                        updateStatus('idle');
                        alert(" 砖 拽专驻");
                    }
                };
            } else {
                alert("驻驻  转.  Chrome.");
            }
        }

        initRecognition();

        // 驻转 砖驻 转
        function changeLang(lang) {
            if (currentLang === lang) return; //  砖
            
            currentLang = lang;
            
            // 注 UI 驻转专
            document.getElementById('btnHe').classList.toggle('active', lang === 'he-IL');
            document.getElementById('btnEn').classList.toggle('active', lang === 'en-US');
            langDisplay.innerText = lang === 'he-IL' ? 'HE' : 'EN';

            //  拽 专注, 爪专 转 转 注
            if (isRecording) {
                recognition.stop(); 
                // -onend  砖-isRecording 注 true 驻注 砖 注 砖驻 砖
                
                // 注  砖转砖
                interimDisplay.innerText = "祝 砖驻...";
                recognition.lang = currentLang; // 注 专转 砖驻
            } else {
                //   拽, 专拽 注 转 专 驻注 
                recognition.lang = lang;
            }
        }

        function toggleRecording() {
            if (!recognition) return;

            if (!isRecording) {
                updateStatus('connecting');
                try { recognition.start(); } catch (e) { console.error(e); }
            } else {
                updateStatus('processing');
                setTimeout(() => {
                    isRecording = false;
                    recognition.stop();
                    interimDisplay.innerText = "...";
                }, 800);
            }
        }

        function updateStatus(state) {
            mainBtn.className = "relative z-10 rounded-full w-20 h-20 flex items-center justify-center text-3xl shadow-xl transition-all duration-300 transform hover:scale-105 active:scale-95 text-white";
            pulseRing.className = "absolute inset-0 rounded-full opacity-0";
            
            switch(state) {
                case 'idle':
                    mainBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    btnIcon.className = "fas fa-microphone";
                    statusBadge.innerText = " 拽";
                    statusBadge.className = "px-4 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-500 mb-4";
                    break;
                case 'connecting':
                    mainBtn.classList.add('bg-yellow-500');
                    btnIcon.className = "fas fa-spinner fa-spin";
                    statusBadge.innerText = "注...";
                    break;
                case 'recording':
                    mainBtn.classList.add('bg-red-500');
                    btnIcon.className = "fas fa-stop";
                    pulseRing.classList.add('pulse-ring');
                    statusBadge.innerHTML = `<span class="flex items-center gap-2"><i class="fas fa-circle text-[10px] animate-pulse"></i> 拽 (${currentLang === 'he-IL' ? '注专转' : '转'})</span>`;
                    statusBadge.className = "px-4 py-1 rounded-full text-sm font-medium bg-red-50 text-red-600 border border-red-100 mb-4";
                    break;
                case 'processing':
                    mainBtn.classList.add('bg-gray-400');
                    btnIcon.className = "fas fa-save";
                    statusBadge.innerText = "砖专...";
                    break;
            }
        }

        function addTranscriptEntry(text) {
            if (!text.trim()) return;
            const now = new Date();
            const timeStr = now.toLocaleTimeString('he-IL', {hour: '2-digit', minute:'2-digit'});
            
            //  砖驻 拽住 住驻爪驻  砖专 转 
            const isEnglish = /^[A-Za-z0-9\s.,?!]*$/.test(text);
            const direction = isEnglish ? 'ltr' : 'rtl';
            const align = isEnglish ? 'text-left' : 'text-right';
            const flag = currentLang === 'he-IL' ? '' : '<span class="mr-1">吼</span>';

            transcriptData.push({ time: timeStr, text: text });
            
            if(document.getElementById('emptyState')) container.innerHTML = ''; 

            const div = document.createElement('div');
            div.className = `bg-white p-3 rounded border-r-4 ${currentLang === 'he-IL' ? 'border-teal-500' : 'border-indigo-500'} shadow-sm ${align} animate-[fadeIn_0.3s_ease-out]`;
            div.style.direction = direction;
            
            div.innerHTML = `
                <span class="text-xs text-gray-400 block mb-1 font-mono flex justify-between">
                    ${timeStr} ${flag}
                </span>
                <p class="text-gray-800 text-lg leading-relaxed">${text}</p>
            `;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            saveToLocal();
            interimDisplay.innerText = "...";
        }

        function exportTxt() {
            if (transcriptData.length === 0) { alert(" 转"); return; }
            let content = "SafeScribe V5 Transcript\n========================\n\n";
            transcriptData.forEach(i => content += `[${i.time}] ${i.text}\n`);
            downloadFile(content);
        }

        function downloadFile(content) {
            const date = new Date().toISOString().slice(0,16).replace(/[:T]/g, '-');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `SafeScribe_${date}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function newMeeting() {
            if(transcriptData.length > 0 && !confirm("拽 ?")) return;
            transcriptData = [];
            localStorage.removeItem('safeScribeV5');
            location.reload();
        }

        function saveToLocal() { localStorage.setItem('safeScribeV5', JSON.stringify(transcriptData)); }
        
        const saved = localStorage.getItem('safeScribeV5');
        if(saved) {
            transcriptData = JSON.parse(saved);
            if(transcriptData.length > 0) {
                container.innerHTML = '';
                transcriptData.forEach(i => addTranscriptEntry(i.text)); // Re-render simple
            }
        }

        async function requestWakeLock() { try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch {} }
        function releaseWakeLock() { if (wakeLock) wakeLock.release().then(() => wakeLock = null); }
    </script>
</body>
</html>
